<!DOCTYPE html>
<html lang="en">
  <head>
    <title>คำนวณภาษี</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container pt-5 mx-auto">
      <div class="row">
        <!-- form to add salary from user have field name lastname salary gurante -->
        <div class="col-md-6">
          <form action="" method="post">
            <div class="form-group">
              <label for="name">ชื่อ-นามสกุล</label>
              <input
                type="text"
                class="form-control"
                name="name"
                id="name"
                placeholder="ชื่อ-นามสกุล"
              />
            </div>
            <div class="form-group">
              <label for="salary">เงินเดือน</label>
              <input
                type="number"
                class="form-control"
                name="salary"
                id="salary"
                placeholder="เงินเดือน"
              />
            </div>
            <div class="form-group">
              <label for="insurance ">เงินประกันชีวิต</label>
              <input
                type="number"
                class="form-control"
                name="insurance"
                id="insurance"
                placeholder="เงินประกันชีวิต"
              />
            </div>
            <button type="submit" class="btn btn-primary" id="saveBtn">
              บันทึก
            </button>
          </form>
          <!-- calculate button -->
          <a href="" id="calculateVate" class="btn btn-success my-4">คำนวณ</a>
          <!-- list to show raw data -->
          <!-- table to show raw data -->
        </div>
      </div>
      <div id="tableBox" class="text-center"></div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let datas = [];
        let error = [];
        const addNewSalary = (e) => {
          e.preventDefault();
          const name = document.getElementById("name").value;
          const salary = document.getElementById("salary").value;
          const insurance = document.getElementById("insurance").value;
          const data = {
            name,
            salary: +salary,
            insurance: +insurance,
          };
          let validate = [];
          if (name === "") {
            validate.push(validateInValid("กรุณากรอกชื่อ-นามสกุล", "name"));
          } else {
            validate.push(validateValid("name"));
          }
          if (salary === "") {
            validate.push(validateInValid("กรุณากรอกเงินเดือน", "salary"));
          } else {
            validate.push(validateValid("salary"));
          }

          if (insurance === "") {
            validate.push(
              validateInValid("กรุณากรอกเงินประกันชีวิต", "insurance")
            );
          } else {
            validate.push(validateValid("insurance"));
          }

          if (
            validate.every((v) => {
              return v === true;
            })
          ) {
            datas.push(data);
            document.getElementById("name").value = "";
            document.getElementById("salary").value = "";
            document.getElementById("insurance").value = "";
            console.log(datas);
            document.getElementById("tableBox").innerHTML =
              generateTable(datas);
          } else {
            console.log("กรุณากรอกข้อมูลให้ครบ");
          }
        };
        document
          .getElementById("saveBtn")
          .addEventListener("click", addNewSalary);
        document
          .getElementById("calculateVate")
          .addEventListener("click", (e) => {
            e.preventDefault();
            document.getElementById("tableBox").innerHTML = generateTable(
              datas,
              true
            );
          });
      });

      const getErrorHtml = (error) => {
        let html = `<div class="invalid-feedback d-block" id="error">${error}</div>`;
        return html;
      };

      const validateInValid = (text, field) => {
        document.getElementById(field).classList.add("is-invalid");
        // insert error html after field check error if error is exist
        if (document.getElementById(field).nextElementSibling?.id === "error") {
          document.getElementById(field).nextSibling.remove();
        }
        document
          .getElementById(field)
          .insertAdjacentHTML("afterend", getErrorHtml(text));
        return false;
      };
      const validateValid = (field) => {
        document.getElementById(field).nextSibling?.remove();
        document.getElementById(field).classList?.remove("is-invalid");
        document.getElementById(field).classList.add("is-valid");
        return true;
      };

      const generateTable = (datas, calvat = false) => {
        const incomeData = datas.map((data) => {
          const netIncome = getNetIncome(data.salary, data.insurance);
          return {
            name: data.name,
            salary: data.salary,
            insurance: data.insurance,
            ...netIncome,
          };
        });
        let html = `<table class="table table-bordered w-100">
        <thead>
          <tr>
            <th scope="col">ชื่อ-นามสกุล</th>
            <th scope="col">เงินเดือน</th>
            <th scope="col">เงินประกันชีวิต</th>
            ${
              calvat
                ? `<th scope="col">หักค่าใช้จ่าย</th>
                <th scope="col">ค่าลดหย่อนส่วนตัว</th>
            <th scope="col">ลดหย่อนประกันชีวิต</th>
            <th scope="col">รายได้สุทธิ</th>
            <th scope="col">อัตราภาษีที่ต้องชำระ</th>
            <th scope="col">ภาษีที่ต้องชำระ</th>
            <th scope="col">รายได้หลังหักภาษี</th>`
                : ""
            }
          </tr>
        </thead>
        <tbody>`;
        incomeData.forEach((data) => {
          html += `<tr>
            <td>${data.name}</td>
            <td>${data.salary.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>
            </td>
            <td>${data.insurance.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>
            ${
              calvat
                ? `<td>${data.expense.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })}</td>
            <td>${data.privateDiscount.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>
            <td>${data.netInsurance.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>
            <td>${data.netIncome.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>
            <td>${data.vatRate}</td>
            <td>${data.vat.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>
            <td>${data.netIncomeAfterTax.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}</td>`
                : ""
            }
          </tr>`;
        });
        html += `</tbody>
        </table>`;
        return html;
      };
      const getNetIncome = (income, insurance) => {
        console.log(income, insurance);
        const expense = getExpense(+income);
        const privateDiscount = 30000;
        const incomeWithDC = +income - expense - privateDiscount;
        const netInsurance = getInsurance(+insurance);
        const netIncome = incomeWithDC - netInsurance;
        const vatRate = calculateVat(netIncome - netInsurance);
        const vat = vatRate * netIncome;
        const netIncomeAfterTax = income - vat;
        return {
          privateDiscount,
          netIncome,
          netIncomeAfterTax,
          netInsurance,
          expense,
          vatRate,
          vat,
        };
      };

      const getExpense = (income) => {
        const expense = income * 0.4;
        if (expense > 60000) {
          return 60000;
        } else if (expense < 0) {
          return 0;
        } else {
          return expense;
        }
      };

      const getInsurance = (insurance) => {
        if (insurance > 50000) {
          return 50000;
        } else if (insurance < 0) {
          return 0;
        } else {
          return insurance;
        }
      };
      const calculateVat = (income) => {
        if (income >= 0 && income <= 50000) {
          return 0;
        } else if (income <= 10000) {
          return 0.05;
        } else if (income <= 500000) {
          return 0.1;
        } else if (income <= 1000000) {
          return 0.2;
        } else if (income <= 4000000) {
          return 0.3;
        } else if (income > 4000000) {
          return 0.37;
        } else {
          return 0;
        }
      };
    </script>
  </body>
</html>
